<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Idle Relay Control</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
    }
    #log {
      margin-top: 16px;
      padding: 8px;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      background: #fafafa;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Idle Relay Control</h1>

  <label>Vehicle</label>
  <select id="deviceSelect"><option>Loading…</option></select>

  <div style="margin:10px 0;">
    <label>Output index:</label>
    <input id="outputIndex" value="1" style="width:60px;">
    &nbsp;&nbsp;
    <label>Pulse seconds:</label>
    <input id="pulseSeconds" value="15" style="width:60px;">
    <button id="pulseBtn">Pulse relay now</button>
  </div>

  <div style="margin:10px 0;">
    <input type="checkbox" id="autoEnable">
    <label for="autoEnable">Enable automatic idle shutdown (Idle > 2m50s)</label>
  </div>

  <div id="log"></div>

  <script>
    geotab.addin.idleRelayControl = (api, state) => {

      const RULE_NAME = "Idle > 2m50s (Auto Shutdown)";
      let idleRuleId = null;
      let autoTimer = null;
      const lastPulse = {};

      const deviceSelect = document.getElementById("deviceSelect");
      const outputIndex = document.getElementById("outputIndex");
      const pulseSeconds = document.getElementById("pulseSeconds");
      const pulseBtn = document.getElementById("pulseBtn");
      const autoEnable = document.getElementById("autoEnable");
      const logEl = document.getElementById("log");

      function log(msg) {
        logEl.textContent = `[${new Date().toISOString()}] ${msg}\n` + logEl.textContent;
      }

      // ---------------------------
      // Load devices using api.get()
      // ---------------------------
      function loadDevices(callback) {
        log("Loading devices from MyGeotab…");
        api.get("Device", {}, function (devices) {
          deviceSelect.innerHTML = "";
          devices.forEach(d => {
            let opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = d.name || d.deviceName || d.serialNumber;
            deviceSelect.appendChild(opt);
          });
          log(`Loaded ${devices.length} devices.`);
          callback && callback();
        }, error => log("ERROR loading devices: " + error.message));
      }

      // --------------------------------------
      // Find the idle rule using api.get()
      // --------------------------------------
      function loadIdleRule() {
        log(`Searching for idle rule named: "${RULE_NAME}"…`);
        api.get("ExceptionRule", { name: RULE_NAME }, function (rules) {
          if (rules.length > 0) {
            idleRuleId = rules[0].id;
            log("Idle rule found. ID = " + idleRuleId);
          } else {
            log("Idle rule NOT found. Auto mode disabled.");
            idleRuleId = null;
          }
        }, error => log("ERROR loading rule: " + error.message));
      }

      // ---------------------------------------
      // Pulse relay: OFF then ON (using SetDeviceParameters)
      // ---------------------------------------
      function pulseRelay(deviceId, index, ms, reason) {
        if (!deviceId) return log("Select a device first.");

        const now = Date.now();
        if (reason === "auto") {
          if (lastPulse[deviceId] && now - lastPulse[deviceId] < 15 * 60 * 1000) {
            return log("Cooldown active — skipping auto pulse.");
          }
        }

        lastPulse[deviceId] = now;
        log(`Pulsing relay on device ${deviceId} for ${ms} ms. Reason: ${reason}`);

        // Turn ON (kill engine for your wiring)
        api.call("SetDeviceParameters", {
          device: { id: deviceId },
          name: "IoxOutput",
          value: JSON.stringify({ channel: index, isRelayOn: true })
        }, () => {

          setTimeout(() => {
            // Turn OFF (restore engine)
            api.call("SetDeviceParameters", {
              device: { id: deviceId },
              name: "IoxOutput",
              value: JSON.stringify({ channel: index, isRelayOn: false })
            }, () => {
              log("Relay pulse complete.");
            }, err => log("ERROR setting relay OFF: " + err.message));

          }, ms);

        }, err => log("ERROR setting relay ON: " + err.message));
      }

      // ------------------------------
      // Automatic idle monitoring
      // ------------------------------
      function checkIdle() {
        if (!idleRuleId) {
          log("Auto check: idle rule ID not loaded; skipping.");
          return;
        }

        const deviceId = deviceSelect.value;
        if (!deviceId) {
          log("Auto check: no device selected.");
          return;
        }

        api.get("ExceptionEvent", {
          ruleSearch: { id: idleRuleId },
          deviceSearch: { id: deviceId },
          fromDate: new Date(Date.now() - 5 * 60 * 1000).toISOString()
        }, function (events) {

          const active = events.some(ev => ev.activeTo == null);
          if (active) {
            log("Active idle detected — triggering auto pulse.");
            pulseRelay(deviceId, parseInt(outputIndex.value), parseInt(pulseSeconds.value) * 1000, "auto");
          }

        }, err => log("ERROR checking idle events: " + err.message));
      }

      // --------------------------------------
      // Init / Focus / Blur
      // --------------------------------------
      return {
        initialize(api, state, done) {
          log("Add-in initialized.");
          loadDevices(() => {
            loadIdleRule();
            done();
          });

          pulseBtn.onclick = () => {
            let dev = deviceSelect.value;
            pulseRelay(dev, parseInt(outputIndex.value), parseInt(pulseSeconds.value) * 1000, "manual");
          };

          autoEnable.onchange = () => {
            if (autoEnable.checked) {
              log("Automatic idle shutdown ENABLED.");
              autoTimer = setInterval(checkIdle, 30000);
            } else {
              log("Automatic idle shutdown DISABLED.");
              clearInterval(autoTimer);
              autoTimer = null;
            }
          };
        },

        focus() {
          log("Idle Relay Control focused.");
        },

        blur() {
          log("Idle Relay Control blurred.");
        }
      };
    };
  </script>
</body>
</html>

